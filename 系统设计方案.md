# 企业网络安全态势感知系统设计方案

## 1. 系统概述

### 1.1 设计目标

基于企业日志数据，设计一套完整的网络安全态势感知与管理系统，实现：
- 实时监控企业网络安全状态
- 自动检测和预警安全威胁
- 提供可视化分析和决策支持
- 支持安全事件追溯和审计

### 1.2 系统定位

本系统定位为企业级网络安全管理平台，服务对象包括：
- **安全运维人员**：实时监控和威胁响应
- **安全管理员**：策略配置和权限管理
- **企业管理层**：安全态势总览和决策支持

## 2. 系统整体架构

### 2.1 架构设计

系统采用**分层架构**设计，包含以下层次：

```
┌─────────────────────────────────────────────────────────┐
│                    展示层 (Presentation Layer)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web控制台   │  │  移动端APP   │  │  大屏展示    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTPS/WebSocket
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  态势感知    │  │  威胁检测    │  │  告警管理    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  行为分析    │  │  报表生成    │  │  审计追溯    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓ REST API
┌─────────────────────────────────────────────────────────┐
│                    服务层 (Service Layer)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  数据处理    │  │  规则引擎    │  │  机器学习    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  数据聚合    │  │  实时计算    │  │  离线分析    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓ Kafka/RabbitMQ
┌─────────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  时序数据库  │  │  关系数据库  │  │  文档数据库  │  │
│  │ (InfluxDB)   │  │  (MySQL)     │  │ (MongoDB)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  缓存层      │  │  对象存储    │  │  搜索引擎    │  │
│  │  (Redis)     │  │  (MinIO)     │  │(Elasticsearch)│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓ Syslog/Filebeat/Agent
┌─────────────────────────────────────────────────────────┐
│                    采集层 (Collection Layer)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  日志采集    │  │  流量采集    │  │  终端监控    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    数据源 (Data Sources)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  服务器日志  │  │  网络设备    │  │  员工终端    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  邮件服务器  │  │  Web服务器   │  │  数据库      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术选型

| 层次 | 组件 | 技术选型 | 说明 |
|------|------|---------|------|
| 展示层 | Web前端 | React + ECharts + Ant Design | 响应式Web界面 |
| | 移动端 | React Native / Flutter | 跨平台移动应用 |
| 应用层 | API网关 | Kong / Nginx | 统一入口、负载均衡 |
| | 微服务 | Spring Boot / FastAPI | 业务逻辑处理 |
| 服务层 | 实时计算 | Apache Flink / Spark Streaming | 流式数据处理 |
| | 离线分析 | Apache Spark | 批量数据分析 |
| | 消息队列 | Kafka / RabbitMQ | 异步消息传递 |
| 数据层 | 时序数据库 | InfluxDB / TimescaleDB | 存储时间序列数据 |
| | 关系数据库 | MySQL / PostgreSQL | 存储结构化数据 |
| | 文档数据库 | MongoDB | 存储半结构化数据 |
| | 搜索引擎 | Elasticsearch | 日志检索和分析 |
| | 缓存 | Redis | 高速缓存 |
| 采集层 | 日志采集 | Filebeat / Fluentd | 日志收集 |
| | 流量采集 | Suricata / Zeek | 网络流量分析 |

## 3. 核心模块设计

### 3.1 数据采集模块

#### 3.1.1 模块功能
- 多源数据采集（服务器、网络设备、终端）
- 数据标准化和预处理
- 数据质量检测和清洗

#### 3.1.2 采集方式

**1. 日志采集**
```yaml
采集方式: Filebeat + Logstash
数据源:
  - 服务器日志: /var/log/auth.log, /var/log/syslog
  - Web服务器: nginx/apache access.log, error.log
  - 应用日志: 自定义应用日志
  - 数据库日志: MySQL slow query log, error log

传输协议: Syslog, TCP/UDP
数据格式: JSON
采集频率: 实时
```

**2. 网络流量采集**
```yaml
采集方式: 镜像端口 + Suricata/Zeek
数据源:
  - 核心交换机镜像流量
  - 边界路由器流量
  - 防火墙日志

传输协议: NetFlow, sFlow
数据格式: JSON
采集频率: 实时
```

**3. 终端监控**
```yaml
采集方式: Agent客户端
数据源:
  - 进程信息
  - 网络连接
  - 文件操作
  - 登录记录

传输协议: HTTPS
数据格式: JSON
采集频率: 5分钟/次
```

#### 3.1.3 数据接口

**采集Agent接口**
```json
POST /api/v1/collector/submit
Content-Type: application/json

{
  "agent_id": "agent-001",
  "timestamp": "2024-12-13T10:30:00Z",
  "data_type": "login_log",
  "data": {
    "user": "admin",
    "source_ip": "10.64.105.123",
    "action": "login",
    "status": "success",
    "protocol": "ssh"
  }
}
```

**响应格式**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "record_id": "rec-123456",
    "received_at": "2024-12-13T10:30:01Z"
  }
}
```

### 3.2 数据处理模块

#### 3.2.1 实时处理流程

```
原始数据 → 数据清洗 → 数据解析 → 数据标准化 → 数据聚合 → 存储
           ↓
        规则匹配 → 威胁检测 → 告警生成 → 通知推送
```

#### 3.2.2 处理规则

**数据清洗规则**
- 去除重复数据
- 过滤无效字段
- 补全缺失字段
- 时间戳标准化

**数据解析规则**
```python
# 登录日志解析示例
{
  "raw_log": "Dec 13 10:30:00 server1 sshd[1234]: Failed password for admin from 10.64.105.123",
  "parsed": {
    "timestamp": "2024-12-13T10:30:00Z",
    "hostname": "server1",
    "service": "sshd",
    "pid": 1234,
    "event_type": "authentication_failure",
    "user": "admin",
    "source_ip": "10.64.105.123"
  }
}
```

#### 3.2.3 数据传输接口

**Kafka Topic设计**
```yaml
topics:
  - raw_logs: 原始日志数据
  - parsed_logs: 解析后的日志
  - network_traffic: 网络流量数据
  - security_events: 安全事件
  - alerts: 告警信息

分区策略: 按数据源IP哈希分区
副本数: 3
保留时间: 7天
```

### 3.3 威胁检测模块

#### 3.3.1 检测规则引擎

**规则类型**

1. **基于阈值的规则**
```yaml
rule_id: R001
name: 暴力破解检测
type: threshold
conditions:
  - field: login_failure_count
    operator: greater_than
    value: 10
    time_window: 5m
action: generate_alert
severity: high
```

2. **基于模式的规则**
```yaml
rule_id: R002
name: 非工作时间登录
type: pattern
conditions:
  - field: login_time
    operator: in_range
    value: [0, 6]  # 0-6点
  - field: user_type
    operator: equals
    value: employee
action: generate_alert
severity: medium
```

3. **基于机器学习的规则**
```yaml
rule_id: R003
name: 异常流量检测
type: ml_model
model: isolation_forest
features:
  - total_traffic
  - connection_count
  - unique_destinations
threshold: 0.8  # 异常分数阈值
action: generate_alert
severity: high
```

#### 3.3.2 检测流程

```
数据输入 → 特征提取 → 规则匹配 → 异常评分 → 告警判定 → 告警输出
                         ↓
                    机器学习模型
```

#### 3.3.3 告警接口

**告警生成接口**
```json
POST /api/v1/alerts/create
{
  "alert_id": "alert-20241213-001",
  "timestamp": "2024-12-13T10:30:00Z",
  "severity": "high",
  "category": "brute_force_attack",
  "title": "检测到暴力破解攻击",
  "description": "用户 admin 在5分钟内登录失败15次",
  "source": {
    "ip": "10.64.105.123",
    "user": "admin"
  },
  "evidence": {
    "failed_attempts": 15,
    "time_window": "5m",
    "protocols": ["ssh", "ftp"]
  },
  "recommended_actions": [
    "封禁源IP",
    "重置用户密码",
    "启用多因素认证"
  ]
}
```

### 3.4 态势感知模块

#### 3.4.1 态势评估指标

**安全态势评分模型**
```
总分 = w1 * 登录安全分 + w2 * 流量安全分 + w3 * 行为安全分 + w4 * 威胁等级分

其中:
- 登录安全分 = 100 - (登录失败率 * 100)
- 流量安全分 = 100 - (异常流量占比 * 100)
- 行为安全分 = 100 - (异常行为占比 * 100)
- 威胁等级分 = 100 - (高危威胁数 * 10 + 中危威胁数 * 5)

权重: w1=0.3, w2=0.3, w3=0.2, w4=0.2
```

#### 3.4.2 态势预测

使用时间序列分析预测未来态势：
- ARIMA模型预测流量趋势
- LSTM模型预测威胁发生概率
- 异常检测模型识别潜在风险

#### 3.4.3 态势展示接口

```json
GET /api/v1/situation/overview

Response:
{
  "timestamp": "2024-12-13T10:30:00Z",
  "overall_score": 78.5,
  "trend": "declining",
  "metrics": {
    "login_security": 85.2,
    "traffic_security": 72.3,
    "behavior_security": 80.1,
    "threat_level": 76.5
  },
  "active_threats": {
    "high": 3,
    "medium": 12,
    "low": 8
  },
  "predictions": {
    "next_hour_score": 76.2,
    "risk_level": "medium"
  }
}
```

### 3.5 可视化展示模块

#### 3.5.1 仪表板设计

**总览仪表板**
- 安全态势评分仪表盘
- 实时威胁地图
- 关键指标卡片（登录次数、流量、告警数）
- 趋势图表（24小时、7天、30天）

**详细分析仪表板**
- 登录安全分析
- 网络流量分析
- 员工行为分析
- 威胁检测详情

#### 3.5.2 交互功能

- **时间范围选择**：支持自定义时间范围查询
- **数据钻取**：从总览到详情的层级钻取
- **实时刷新**：WebSocket推送实时数据更新
- **导出功能**：支持PDF、Excel、图片导出

#### 3.5.3 可视化API

```json
GET /api/v1/visualization/login-distribution
Parameters:
  - start_time: 2024-12-01T00:00:00Z
  - end_time: 2024-12-13T23:59:59Z
  - granularity: hour

Response:
{
  "data": [
    {
      "timestamp": "2024-12-13T00:00:00Z",
      "success_count": 1234,
      "failure_count": 56
    },
    ...
  ],
  "summary": {
    "total_success": 45678,
    "total_failure": 2345,
    "failure_rate": 0.049
  }
}
```

### 3.6 报表管理模块

#### 3.6.1 报表类型

1. **日报**：每日安全态势摘要
2. **周报**：每周安全趋势分析
3. **月报**：每月安全总结和建议
4. **专项报告**：针对特定安全事件的详细分析

#### 3.6.2 报表生成流程

```
定时任务触发 → 数据查询 → 数据分析 → 报表生成 → 报表分发
                                    ↓
                              PDF/Excel/HTML
```

#### 3.6.3 报表接口

```json
POST /api/v1/reports/generate
{
  "report_type": "daily",
  "date": "2024-12-13",
  "format": "pdf",
  "recipients": ["admin@company.com"],
  "sections": [
    "overview",
    "threats",
    "recommendations"
  ]
}
```
